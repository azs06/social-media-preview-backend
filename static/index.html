<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Post Previewer and Scorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .platform-tab.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
        .preview-content {
            min-height: 80px;
            background-color: #f9fafb; /* gray-50 */
            border: 1px dashed #d1d5db; /* gray-300 */
            padding: 12px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Custom styles for file input */
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'Select Image';
            display: inline-block;
            background: #3b82f6; /* blue-500 */
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem; /* text-sm */
        }
        .custom-file-input:hover::before {
            background: #2563eb; /* blue-600 */
        }
        .custom-file-input:active::before {
            background: #1d4ed8; /* blue-700 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-blue-600">Social Media Post Scorer</h1>
            <p class="text-center text-gray-500 mt-2">Craft the perfect post and get an AI-powered performance score!</p>
        </header>

        <div class="mb-6">
            <label for="postContent" class="block text-sm font-medium text-gray-700 mb-1">Post Content:</label>
            <textarea id="postContent" rows="5" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Write your social media post here..."></textarea>
        </div>

        <div class="mb-6">
            <label for="postImage" class="block text-sm font-medium text-gray-700 mb-1">Upload Image (Optional):</label>
            <div class="flex items-center space-x-4">
                <input type="file" id="postImage" accept="image/*" class="custom-file-input text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button id="removeImageBtn" class="hidden px-3 py-2 text-sm font-medium text-red-600 bg-red-100 hover:bg-red-200 rounded-lg">Remove Image</button>
            </div>
            <div class="mt-4">
                <img id="imagePreview" src="#" alt="Image Preview" class="hidden object-contain mx-auto"/>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Platform:</label>
            <div class="flex border-b border-gray-200">
                <button data-platform="twitter" class="platform-tab py-3 px-4 text-sm font-medium text-gray-500 hover:text-blue-500 border-b-2 border-transparent focus:outline-none active">Twitter</button>
                <button data-platform="facebook" class="platform-tab py-3 px-4 text-sm font-medium text-gray-500 hover:text-blue-500 border-b-2 border-transparent focus:outline-none">Facebook</button>
                <button data-platform="linkedin" class="platform-tab py-3 px-4 text-sm font-medium text-gray-500 hover:text-blue-500 border-b-2 border-transparent focus:outline-none">LinkedIn</button>
            </div>
        </div>

        <div class="mb-8 text-center">
            <button id="getScoreBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Get AI Score & Feedback
            </button>
        </div>

        <div id="scoreArea" class="hidden p-6 bg-indigo-50 border border-indigo-200 rounded-lg">
            <h3 class="text-xl font-semibold text-indigo-700 mb-3">Analysis Results:</h3>
            <p class="text-lg"><strong>Score:</strong> <span id="scoreValue" class="font-bold text-indigo-600">--/100</span></p>
            <p class="mt-2"><strong>Feedback:</strong> <span id="scoreFeedback" class="text-gray-700">Waiting for analysis...</span></p>
            <div id="suggestionsArea" class="hidden mt-3">
                 <p class="font-semibold text-indigo-700"><strong>Content Suggestions:</strong></p>
                 <p id="scoreSuggestions" class="text-gray-700 whitespace-pre-wrap"></p>
            </div>
        </div>

        <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Live Preview:</h3>
            <div id="previewTwitter" class="border p-4 rounded-lg bg-white shadow">
                <h4 class="font-bold text-blue-500 mb-2">Twitter Preview</h4>
                <div id="twitterPostContent" class="preview-content text-sm">Your post will appear here...</div>
                <img id="twitterImagePreview" src="#" alt="" class="hidden mt-2 max-w-full h-auto rounded"/>
            </div>
            <div id="previewFacebook" class="hidden border p-4 rounded-lg bg-white shadow">
                <h4 class="font-bold text-blue-700 mb-2">Facebook Preview</h4>
                <div id="facebookPostContent" class="preview-content">Your post will appear here...</div>
                <img id="facebookImagePreview" src="#" alt="" class="hidden mt-2 max-w-full h-auto rounded"/>
            </div>
            <div id="previewLinkedIn" class="hidden border p-4 rounded-lg bg-white shadow">
                <h4 class="font-bold text-blue-800 mb-2">LinkedIn Preview</h4>
                <div id="linkedinPostContent" class="preview-content">Your post will appear here...</div>
                <img id="linkedinImagePreview" src="#" alt="" class="hidden mt-2 max-w-full h-auto rounded"/>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Main content and platform elements
            const postContentTextarea = document.getElementById("postContent");
            const platformTabs = document.querySelectorAll(".platform-tab");
            
            // Image elements
            const postImageInput = document.getElementById("postImage");
            const imagePreview = document.getElementById("imagePreview");
            const removeImageBtn = document.getElementById("removeImageBtn");

            // Preview elements
            const previewPlatforms = {
                twitter: document.getElementById("previewTwitter"),
                facebook: document.getElementById("previewFacebook"),
                linkedin: document.getElementById("previewLinkedIn")
            };
            const postContentAreas = {
                twitter: document.getElementById("twitterPostContent"),
                facebook: document.getElementById("facebookPostContent"),
                linkedin: document.getElementById("linkedinPostContent")
            };
            // Image previews for each platform
            const platformImagePreviews = {
                twitter: document.getElementById("twitterImagePreview"),
                facebook: document.getElementById("facebookImagePreview"),
                linkedin: document.getElementById("linkedinImagePreview")
            };

            // Score and feedback elements
            const getScoreBtn = document.getElementById("getScoreBtn");
            const scoreArea = document.getElementById("scoreArea");
            const scoreValue = document.getElementById("scoreValue");
            const scoreFeedback = document.getElementById("scoreFeedback");
            const suggestionsArea = document.getElementById("suggestionsArea");
            const scoreSuggestions = document.getElementById("scoreSuggestions");

            let currentPlatform = "twitter"; // Default platform
            let currentImageBase64 = null; // To store the base64 string of the image

            // --- Image Handling ---
            if (postImageInput) {
                postImageInput.addEventListener("change", function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove("hidden");
                            removeImageBtn.classList.remove("hidden");
                            // Store base64 string without the data URL prefix
                            currentImageBase64 = e.target.result.split(',')[1];
                            updateAllImagePreviews(e.target.result);
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (removeImageBtn) {
                removeImageBtn.addEventListener("click", () => {
                    postImageInput.value = ""; // Clear the file input
                    imagePreview.src = "#";
                    imagePreview.classList.add("hidden");
                    removeImageBtn.classList.add("hidden");
                    currentImageBase64 = null;
                    updateAllImagePreviews(null); // Clear platform image previews
                });
            }
            
            function updateAllImagePreviews(src) {
                for (const platform in platformImagePreviews) {
                    if (platformImagePreviews[platform]) {
                        if (src) {
                            platformImagePreviews[platform].src = src;
                            platformImagePreviews[platform].classList.remove("hidden");
                        } else {
                            platformImagePreviews[platform].src = "#";
                            platformImagePreviews[platform].classList.add("hidden");
                        }
                    }
                }
            }


            // --- Content and Platform Preview Logic ---
            function updateAllTextPreviews(content) {
                for (const platform in postContentAreas) {
                    if (postContentAreas[platform]) {
                        postContentAreas[platform].textContent = content || "Your post will appear here...";
                    }
                }
            }

            function switchPlatformView(platform) {
                currentPlatform = platform;
                platformTabs.forEach(tab => {
                    tab.classList.remove("active", "border-blue-500", "text-blue-500", "font-semibold");
                    tab.classList.add("text-gray-500", "hover:text-blue-500", "border-transparent");
                    if (tab.dataset.platform === platform) {
                        tab.classList.add("active", "border-blue-500", "text-blue-500", "font-semibold");
                        tab.classList.remove("text-gray-500", "hover:text-blue-500", "border-transparent");
                    }
                });

                for (const key in previewPlatforms) {
                    if (previewPlatforms[key]) {
                        previewPlatforms[key].classList.add("hidden");
                    }
                }
                if (previewPlatforms[platform]) {
                    previewPlatforms[platform].classList.remove("hidden");
                }
            }

            if (postContentTextarea) {
                postContentTextarea.addEventListener("input", (e) => {
                    updateAllTextPreviews(e.target.value);
                });
            }

            platformTabs.forEach(tab => {
                tab.addEventListener("click", () => {
                    switchPlatformView(tab.dataset.platform);
                });
            });

            // --- API Call and Score Display ---
            if (getScoreBtn) {
                getScoreBtn.addEventListener("click", async () => {
                    const postText = postContentTextarea.value.trim();
                    if (!postText) {
                        // Using a more prominent way to show error, instead of alert.
                        scoreArea.classList.remove("hidden");
                        scoreValue.textContent = "N/A";
                        scoreFeedback.textContent = "Post content cannot be empty. Please write something.";
                        suggestionsArea.classList.add("hidden");
                        scoreSuggestions.textContent = "";
                        return;
                    }

                    scoreArea.classList.remove("hidden");
                    scoreValue.textContent = "--/100";
                    scoreFeedback.textContent = "Analyzing... please wait.";
                    suggestionsArea.classList.add("hidden");
                    scoreSuggestions.textContent = "";
                    getScoreBtn.disabled = true;
                    getScoreBtn.classList.add("opacity-50", "cursor-not-allowed");

                    const requestBody = {
                        post_text: postText,
                        platform: currentPlatform
                    };

                    if (currentImageBase64) {
                        requestBody.image_base64 = currentImageBase64;
                    }

                    try {
                        const response = await fetch("/api/score_post", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(requestBody),
                        });

                        const result = await response.json();

                        if (response.ok) {
                            scoreValue.textContent = `${result.score}/100`;
                            scoreFeedback.textContent = result.feedback;
                            if (result.content_suggestions && result.content_suggestions.trim() !== "") {
                                scoreSuggestions.textContent = result.content_suggestions;
                                suggestionsArea.classList.remove("hidden");
                            } else {
                                suggestionsArea.classList.add("hidden");
                            }
                        } else {
                            scoreValue.textContent = "Error";
                            scoreFeedback.textContent = result.error || "Failed to get score. Please try again.";
                            suggestionsArea.classList.add("hidden");
                        }
                    } catch (error) {
                        console.error("Error fetching score:", error);
                        scoreValue.textContent = "Error";
                        scoreFeedback.textContent = "An error occurred while contacting the scoring service.";
                        suggestionsArea.classList.add("hidden");
                    } finally {
                        getScoreBtn.disabled = false;
                        getScoreBtn.classList.remove("opacity-50", "cursor-not-allowed");
                    }
                });
            }

            // Initial setup
            switchPlatformView(currentPlatform);
            updateAllTextPreviews(postContentTextarea ? postContentTextarea.value : "");
            updateAllImagePreviews(null); // Ensure image previews are initially hidden
        });
    </script>
</body>
</html>
